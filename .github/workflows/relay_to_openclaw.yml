# Relay GitHub events to OpenClaw via webhook
# OpenClaw translates the event into Japanese and posts it to Discord
#
# Required secrets:
#   OPENCLAW_WEBHOOK_URL - OpenClaw hooks endpoint URL
#   OPENCLAW_HOOKS_TOKEN - Bearer token for OpenClaw hooks authentication
#   OPENCLAW_DISCORD_CHANNEL - Discord channel ID for delivery

name: Relay to OpenClaw

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]
  pull_request_target:
    types: [opened]
  pull_request_review_comment:
    types: [created]

jobs:
  relay:
    runs-on: ubuntu-latest
    steps:
      - name: Forward event to OpenClaw
        env:
          GH_EVENT: ${{ toJSON(github.event) }}
          OPENCLAW_WEBHOOK_URL: ${{ secrets.OPENCLAW_WEBHOOK_URL }}
          OPENCLAW_HOOKS_TOKEN: ${{ secrets.OPENCLAW_HOOKS_TOKEN }}
          OPENCLAW_DISCORD_CHANNEL: ${{ secrets.OPENCLAW_DISCORD_CHANNEL }}
        run: |
          # Extract only the fields we need to avoid 413
          TITLE=$(echo "$GH_EVENT" | jq -r '.issue.title // .pull_request.title // ""')
          BODY=$(echo "$GH_EVENT" | jq -r '.comment.body // .issue.body // .pull_request.body // ""')
          URL=$(echo "$GH_EVENT" | jq -r '.comment.html_url // .issue.html_url // .pull_request.html_url // ""')
          USER=$(echo "$GH_EVENT" | jq -r '.sender.login // ""')

          jq -n \
            --arg msg "GitHub ${{ github.event_name }} on ${{ github.repository }}

          user: $USER
          title: $TITLE
          body: $BODY
          url: $URL

          Translate all of the above content into Japanese exactly as written. Do not summarize or omit anything. Post the full translation to Discord." \
            --arg ch "discord" \
            --arg to "$OPENCLAW_DISCORD_CHANNEL" \
            '{message: $msg, deliver: true, channel: $ch, to: $to, name: "GitHub", agentId: "github-hook", announce: false}' | \
          curl -sf -X POST \
            "${OPENCLAW_WEBHOOK_URL}/hooks/agent" \
            -H "Authorization: Bearer ${OPENCLAW_HOOKS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d @-
